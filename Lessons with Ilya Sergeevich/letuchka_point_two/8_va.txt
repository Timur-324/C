Функции с переменным числом аргументов – это функции, которые могут принимать различное количество параметров при каждом вызове. Классическим примером такой функции является printf, где форматная строка определяет, сколько и какие аргументы передаются.

─────────────────────────────  
1. Объявление функции с переменным числом аргументов

Чтобы объявить функцию с переменным числом аргументов, после обязательных параметров указывается троеточие. Например:

  int my_printf(const char *format, ...);

Здесь параметр format является обязательным, а троеточие (...) сигнализирует, что дальше может следовать переменное число аргументов.

─────────────────────────────  
2. Работа со списком аргументов переменной длины

Для работы с такими аргументами в языке Си используется заголовочный файл <stdarg.h>, который определяет несколько макросов и типов:

  • va_list – тип, предназначенный для хранения информации о списке аргументов.  
  • va_start – инициализирует объект типа va_list для последующего прохождения списка аргументов.  
  • va_arg – извлекает следующий аргумент указанного типа из списка.  
  • va_end – выполняет завершающие операции с va_list (например, освобождает выделенные ресурсы, если это необходимо).

─────────────────────────────  
3. Основные макросы – пример использования

Ниже приведён пример функции, суммирующей произвольное количество целых аргументов:

  #include <stdio.h>
  #include <stdarg.h>

  // Функция, суммирующая n чисел
  int sum(int count, ...) {
   int result = 0;
   va_list args;           // объявляем объект для работы с аргументами

   va_start(args, count);  // инициализируем список аргументов; параметр count – последний обязательный аргумент

   for (int i = 0; i < count; i++) {
    // извлекаем очередной аргумент типа int
    result += va_arg(args, int);
   }

   va_end(args);           // завершаем работу со списком аргументов
   return result;
  }

  int main(void) {
   printf("Сумма: %d\n", sum(4, 10, 20, 30, 40)); // передается сначала количество аргументов, затем сами аргументы
   return 0;
  }

В данном примере функция sum принимает первым параметром количество следующих аргументов, которые ожидаются в виде целых чисел. После выполнения цикла с использованием макроса va_arg функция суммирует переданные значения.

─────────────────────────────  
4. Порядок работы с макросами

  1. Объявление объекта типа va_list (например, args).  
  2. Вызов макроса va_start с указанием объекта и последнего обязательного аргумента: va_start(args, last_fixed_param).  
  3. Использование макроса va_arg для получения очередного аргумента с указанием его типа.  
  4. После завершения работы – вызов макроса va_end.

Важно помнить, что типы аргументов должны соответствовать тому, что ожидает функция, иначе результат может оказаться неопределённым.

─────────────────────────────  
5. Дополнительный макрос: va_copy

В стандарте C99 введён макрос va_copy, который позволяет копировать один объект va_list в другой. Это бывает полезно, если необходимо пройтись по аргументам более одного раза.

Пример:
  va_list args_copy;
  va_copy(args_copy, args);
  // теперь можно работать с args_copy независимо от args
  va_end(args_copy);

─────────────────────────────  
Заключение

Функции с переменным числом аргументов предоставляют гибкость при работе с неопределённым числом параметров в вызове функции. Макросы из <stdarg.h> – va_list, va_start, va_arg, va_end (и, при необходимости, va_copy) – являются инструментами для организации работы с таким списком аргументов. Эти механизмы широко используются в стандартной библиотеке языка C и позволяют создавать универсальные функции, подобные printf, которые могут адаптироваться к разному количеству входных данных.